import { Meta } from '@storybook/addon-docs/blocks'

<Meta title="Docs/Airspace/空港制限表面" />

# 空港制限表面（Restriction Surfaces）

**航空法に基づく空港周辺の制限表面**を地図上に可視化するドキュメントです。

> ⚠️ **免責事項**
>
> このドキュメントはアプリケーションの実装説明です。実際の飛行計画においては、必ず以下の公式情報に従ってください：
> - 国土交通省 航空局
> - DIPS 2.0（ドローン情報基盤システム）
> - 各空港管理者の公式情報
>
> **本表示は安全理解の補助であり、飛行許可・承認の可否を保証するものではありません。**

---

## 制限表面とは

**制限表面**とは、**航空法第49条および第56条の3**に基づき、航空機の安全な離着陸を確保するため、空港周辺の一定空間を障害物のない状態に保つための基準面です。

### 法的根拠

- **航空法 第49条**: 空港等における制限表面
- **航空法 第56条の3**: 制限表面上の物件設置の禁止
- **航空法 第2条**: 制限表面の定義（第8項〜第13項）
- **航空法施行規則**: 勾配・距離の詳細規定

---

## 6つの制限表面（航空法第2条第8項〜第13項）

<table>
  <thead>
    <tr>
      <th>種別</th>
      <th>定義（航空法）</th>
      <th>勾配</th>
      <th>参考URL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>進入表面</strong> (Approach Surface)</td>
      <td>着陸帯の短辺に接続し、水平面に対し上方へ伸びる平面。進入区域は着陸帯中心線の延長3,000mまで広がる</td>
      <td><strong>1:50</strong> (上方)</td>
      <td><a href="https://www.cab.mlit.go.jp/tcab/restriction/02.html">東京航空局</a></td>
    </tr>
    <tr>
      <td><strong>水平表面</strong> (Horizontal Surface)</td>
      <td>空港標点の垂直上方45mの点を中心とする水平面</td>
      <td>高さ45m、半径<strong>4,000m</strong></td>
      <td><a href="https://www.cab.mlit.go.jp/tcab/restriction/02.html">東京航空局</a></td>
    </tr>
    <tr>
      <td><strong>転移表面</strong> (Transitional Surface)</td>
      <td>進入表面の斜辺および着陸帯の長辺を含む平面で、外側上方へ伸び、水平表面との接線で終わる</td>
      <td><strong>1:7</strong> (外側上方)</td>
      <td><a href="https://www.cab.mlit.go.jp/tcab/restriction/02.html">東京航空局</a></td>
    </tr>
    <tr>
      <td><strong>延長進入表面</strong> (Extended Approach)</td>
      <td>進入表面をさらに外側へ延長した平面</td>
      <td><strong>1:50</strong> (水平距離15,000mまで)</td>
      <td><a href="https://www.cab.mlit.go.jp/tcab/restriction/02.html">東京航空局</a></td>
    </tr>
    <tr>
      <td><strong>円錐表面</strong> (Conical Surface)</td>
      <td>水平表面の外縁に接続し、外側上方へ伸びる円錐面</td>
      <td><strong>1:50</strong> (外側上方、半径16,500m)</td>
      <td><a href="https://www.cab.mlit.go.jp/tcab/restriction/02.html">東京航空局</a></td>
    </tr>
    <tr>
      <td><strong>外側水平表面</strong> (Outer Horizontal)</td>
      <td>より大型の空港に適用される外側の水平面</td>
      <td>半径<strong>24,000m</strong></td>
      <td><a href="https://www.cab.mlit.go.jp/tcab/restriction/02.html">東京航空局</a></td>
    </tr>
  </tbody>
</table>

---

## データソース

### 国土地理院 kokuarea ベクトルタイル（公式）

本アプリケーションは、**国土地理院が提供する公式の kokuarea ベクトルタイル**を使用しています。

```
https://maps.gsi.go.jp/xyz/kokuarea/{z}/{x}/{y}.geojson
```

#### データの法的根拠

**航空法第132条の85、航空法施行規則第236条の71**に基づく、無人航空機の飛行禁止空域（空港等の周辺空域）を表示します。

- **緑色の面**: 上空での飛行が禁止される**制限表面**
- **紫色の面**: 上空・下の空域での飛行が禁止される**進入表面・転移表面・空港等敷地**

#### データ仕様

<table>
  <thead>
    <tr>
      <th>項目</th>
      <th>内容</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>提供形式</strong></td>
      <td>GeoJSON (Polygon)</td>
    </tr>
    <tr>
      <td><strong>ズームレベル</strong></td>
      <td>z=8 固定</td>
    </tr>
    <tr>
      <td><strong>更新日</strong></td>
      <td>2025年2月14日（タイルメタデータより）</td>
    </tr>
    <tr>
      <td><strong>データ内容</strong></td>
      <td>制限表面の形状ポリゴンと名称</td>
    </tr>
    <tr>
      <td><strong>公式地図</strong></td>
      <td><a href="https://maps.gsi.go.jp/#12/37.414305/137.059499/&base=std&ls=std%7Ckokuarea&disp=11&lcd=kokuarea&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m">地理院地図 kokuarea レイヤー</a></td>
    </tr>
  </tbody>
</table>

#### 重要な注意事項（国土地理院より）

> この情報には誤差が含まれている場合があります。また空港等の敷地については工事等により変更がある場合がありますので、**境界付近等正確な空域については空港等の管理者に確認願います**。
>
> 詳細については、[国土交通省ホームページ](https://www.mlit.go.jp/koku/)で確認してください。

---

## 実装方法

### 形状生成について

> **重要**: 本アプリケーションは**制限表面の形状を計算していません**。

国土地理院の kokuarea タイルに含まれる**公式の既成ポリゴンをそのまま描画**しています。進入表面の「扇形」形状や転移表面の傾斜面は、すべて**タイルデータとして提供されたポリゴン**です。

#### なぜ計算しないのか

制限表面の正確な形状計算には、以下の情報が必要です：

- 滑走路の正確な座標と方位
- 着陸帯の寸法
- 空港種別（精密進入型、非精密進入型など）
- 滑走路延長と幅
- 航空法施行規則による詳細パラメータ

これらのデータを網羅的に管理するより、**国土地理院の公式データを使用する方が正確かつ信頼性が高い**です。

### データの分類方法

kokuarea タイルのGeoJSONには、`name` プロパティに制限表面の種類が含まれています：

```json
{
  "type": "Feature",
  "properties": {
    "name": "羽田空港進入表面"
  },
  "geometry": {
    "type": "Polygon",
    "coordinates": [...]
  }
}
```

アプリケーションは `name` 属性から以下のキーワードを検出して分類します：

<table>
  <thead>
    <tr>
      <th>キーワード</th>
      <th>分類</th>
      <th>表示色</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>「進入表面」</td>
      <td>Approach Surface</td>
      <td>緑色</td>
    </tr>
    <tr>
      <td>「延長進入表面」</td>
      <td>Extended Approach</td>
      <td>淡緑色</td>
    </tr>
    <tr>
      <td>「転移表面」</td>
      <td>Transitional Surface</td>
      <td>黄色</td>
    </tr>
    <tr>
      <td>「水平表面」</td>
      <td>Horizontal Surface</td>
      <td>紫色</td>
    </tr>
    <tr>
      <td>「外側水平表面」</td>
      <td>Outer Horizontal</td>
      <td>淡紫色</td>
    </tr>
    <tr>
      <td>「円錐表面」</td>
      <td>Conical Surface</td>
      <td>濃紫色</td>
    </tr>
  </tbody>
</table>

実装: `src/lib/services/restrictionSurfaces.ts:258-308`

---

## 表示の意図（UX）

- 円だけでは読み取りにくい**進入方向のリスク**を視覚化する
- 空港に向かって広がる空域の**方向性**を直感的に示す
- 航空法に基づく**公式データ**を使用することで信頼性を確保

## 制限表面の計算式（参考情報）

> **注意**: 以下は制限表面を自前で計算する場合の参考情報です。本アプリケーションは kokuarea タイルの公式データを使用するため、これらの計算は実装していません。

### 計算に必要な入力データ

制限表面を計算するには、以下の空港情報が必要です：

- **空港標点**（緯度・経度）
- **滑走路方向**（磁方位または真方位）
- **着陸帯の寸法**（長さ・幅）
- **空港の種類**（国際空港・地方空港など）

### 各制限表面の計算式

#### 1. 水平表面（Horizontal Surface）

**定義**: 空港標点を中心とする円形の水平面

**計算パラメータ**:
- 中心点: 空港標点
- 半径: 4,000m（標準値、空港により異なる場合あり）
- 基準高さ: 空港標点上方45m

**ポリゴン生成**:
```
中心点を (lat, lng) として、半径4,000mの円形ポリゴンを生成
高さは45mで水平
```

#### 2. 進入表面（Approach Surface）

**定義**: 着陸帯短辺の外側から滑走路方向に延びる傾斜面

**計算パラメータ**:
- 起点: 着陸帯短辺の外側端
- 方向: 滑走路方向
- 勾配: 1:50（水平距離50mに対して1m上昇）
- 長さ: 空港種別により異なる（標準15,000m）

**ポリゴン生成**:
```
1. 着陸帯短辺の外側端を起点とする
2. 滑走路方向に延長
3. 幅は着陸帯短辺の幅から外側に拡張（標準60m）
4. 勾配1:50で上昇する台形ポリゴンを生成
```

**計算式**:
```
距離dにおける高さh = d / 50
ポリゴンの外側幅 = 着陸帯幅 + (d × 拡張率)
```

#### 3. 転移表面（Transitional Surface）

**定義**: 着陸帯の長辺と進入表面側辺から1:7勾配で上昇

**計算パラメータ**:
- 起点: 着陸帯の長辺
- 勾配: 1:7（水平距離7mに対して1m上昇）
- 範囲: 進入表面の側辺まで

**ポリゴン生成**:
```
1. 着陸帯の長辺を基準線とする
2. 進入表面の側辺まで延長
3. 勾配1:7で上昇するポリゴンを生成
```

**計算式**:
```
距離dにおける高さh = d / 7
```

#### 4. 円錐表面（Conical Surface）

**定義**: 水平表面の外縁から1:20勾配で上昇する円錐面

**計算パラメータ**:
- 起点: 水平表面の外縁（半径4,000mの円周）
- 勾配: 1:20（水平距離20mに対して1m上昇）
- 基準高さ: 45m（水平表面の高さ）

**ポリゴン生成**:
```
1. 水平表面の外縁（半径4,000m）を起点とする
2. 外側に拡張しながら上昇
3. 勾配1:20で上昇する円錐形ポリゴンを生成
```

**計算式**:
```
半径rにおける高さh = 45 + (r - 4000) / 20
ただし、r >= 4000m
```

#### 5. 延長進入表面（Extended Approach Surface）

**定義**: 進入表面を15,000m延長した平面

**計算パラメータ**:
- 起点: 進入表面の終点
- 延長距離: 15,000m
- 勾配: 進入表面と同じ1:50

**ポリゴン生成**:
```
1. 進入表面の終点からさらに延長
2. 同じ勾配1:50を維持
3. 幅は進入表面の終点幅を維持
```

#### 6. 外側水平表面（Outer Horizontal Surface）

**定義**: 円錐表面上縁を含む、半径24,000mの水平面

**計算パラメータ**:
- 中心点: 空港標点
- 半径: 24,000m
- 基準高さ: 円錐表面上縁の高さ

**ポリゴン生成**:
```
1. 空港標点を中心とする半径24,000mの円形ポリゴン
2. 高さは円錐表面上縁の高さで水平
```

**計算式**:
```
円錐表面上縁の半径 = 4000 + (h - 45) × 20
外側水平表面の高さ = 円錐表面上縁の高さ
```

### 実装時の注意点

1. **空港ごとの差異**: 上記は標準的な計算式です。実際の空港では、滑走路の長さ・幅、進入方向、空港種別によりパラメータが異なります。

2. **座標系**: 計算時は適切な座標系（UTMなど）を使用し、最後にWGS84（緯度・経度）に変換します。

3. **ポリゴンの精度**: 円形や円錐形のポリゴンは、適切な数の頂点で近似します（通常32-64点）。

4. **高さの扱い**: 制限表面は3次元の概念ですが、地図上では2次元ポリゴンとして投影表示します。

5. **参考データの活用**: 国土地理院のベクトルタイルデータを参考に、計算結果の妥当性を検証します。

> **注意**: このドキュメントは「扇状形状を計算で生成する方法」を説明するものです。  
> 既存のベクトルタイルデータをそのまま描画するのではなく、計算ロジックで生成するための実装指針です。  
> 制限表面の計算式やパラメータについては、航空法の規定と国土地理院の公式ドキュメントを参照してください。

### 分類ルール（概要）

`name` 属性の文字列を中心に判定し、該当しない場合は他の文字列プロパティも参照します。  
主な分類は以下です。

**延長進入表面**
- 判定キーワード: `延長進入表面`, `extended approach`
- UI ラベル: 延長進入表面

**進入表面**
- 判定キーワード: `進入表面`, `approach`
- UI ラベル: 進入表面

**転移表面**
- 判定キーワード: `転移表面`, `transitional`
- UI ラベル: 転移表面

**外側水平表面**
- 判定キーワード: `外側水平表面`, `outer horizontal`
- UI ラベル: 外側水平表面

**水平表面**
- 判定キーワード: `水平表面`, `horizontal`
- UI ラベル: 水平表面

**円錐表面**
- 判定キーワード: `円錐表面`, `conical`
- UI ラベル: 円錐表面

**その他**
- 判定キーワード: いずれにも該当しない
- UI ラベル: 空港周辺空域

## フォールバック円の意図

制限表面タイルが取得できない場合は、**空港の円形ゾーン**を表示します。  
これは「最低限の注意喚起」を目的としたフォールバックで、**法的境界ではありません**。

発生例:
- ズーム 8 未満
- タイル数上限超過
- 取得エラー

## 表示条件とUIの約束

- 表示トグル: 「空港制限表面」ON で表示
- ラベル表示: ズーム 10 以上
- ラベル文字: `__surface_label` を優先、未設定時は `name`
- 色分け: `RESTRICTION_SURFACE_STYLES` を使用

## 実装参照

- `src/lib/services/restrictionSurfaces.ts`
- `src/components/Map/Map.jsx`
- `src/lib/services/airports.ts`（フォールバック円）

---

## トラブルシュート

### 円形しか表示されない

- **原因1**: ズームレベルが8未満
- **原因2**: タイル数が64を超過（広域表示）
- **原因3**: kokuarea タイルの取得失敗（ネットワークエラー）

**対処**: ズームインして特定の空港周辺を表示してください。

### ラベルが表示されない

- **原因**: ズームレベルが10未満
- **対処**: さらにズームインしてください。

### 制限表面が古い

- **確認**: kokuarea タイルの最終更新日は 2025年2月14日
- **対処**: 最新情報は各空港の公式サイトで確認してください。

---

## 実装ファイル

<table>
  <thead>
    <tr>
      <th>ファイル</th>
      <th>内容</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>src/lib/services/restrictionSurfaces.ts</code></td>
      <td>制限表面データ取得・分類ロジック</td>
    </tr>
    <tr>
      <td><code>src/lib/services/airports.ts</code></td>
      <td>空港データ（フォールバック円形用）</td>
    </tr>
    <tr>
      <td><code>src/hooks/useCustomLayers.js</code></td>
      <td>MapLibre カスタムレイヤー管理</td>
    </tr>
    <tr>
      <td><code>src/components/Map/Map.jsx</code></td>
      <td>地図表示とレイヤー制御</td>
    </tr>
    <tr>
      <td><code>api/kokuarea.js</code></td>
      <td>GSI タイルプロキシ（CORS対策）</td>
    </tr>
    <tr>
      <td><code>vite.config.js</code></td>
      <td>開発環境プロキシ設定</td>
    </tr>
  </tbody>
</table>

---

## 公式リンク・参考資料

### 航空法・制限表面

- [国土交通省 東京航空局 - 制限表面](https://www.cab.mlit.go.jp/tcab/restriction/02.html)
- [国土交通省 大阪航空局 - 制限表面](https://www.cab.mlit.go.jp/wcab/measure/restriction.html)
- [航空法における制限表面 - Wikipedia](https://ja.wikipedia.org/wiki/%E5%88%B6%E9%99%90%E8%A1%A8%E9%9D%A2)
- [国土交通省 航空局](https://www.mlit.go.jp/koku/)

### データソース

- [地理院地図 kokuarea レイヤー](https://maps.gsi.go.jp/#12/37.414305/137.059499/&base=std&ls=std%7Ckokuarea&disp=11&lcd=kokuarea&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1&d=m)
- [国土地理院 公式サイト](https://www.gsi.go.jp/)
- kokuarea タイル URL: `https://maps.gsi.go.jp/xyz/kokuarea/{z}/{x}/{y}.geojson`

### DIPS（ドローン情報基盤システム）

- [DIPS 2.0 公式ポータル](https://www.ossportal.dips.mlit.go.jp/)
- [国土交通省 ドローン情報基盤システム](https://www.mlit.go.jp/koku/koku_ua_dips.html)

---

**更新日**: 2026年1月22日
**準拠**: 航空法（昭和27年法律第231号）、航空法施行規則第236条の71、国土地理院 kokuarea ベクトルタイル
**データ出典**: 国土地理院 (最終更新: 2025年2月14日)
