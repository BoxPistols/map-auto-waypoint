import { Meta } from '@storybook/addon-docs/blocks'

<Meta title="Map/マウスイベント仕様" />

# マウスイベント仕様書

Drone Waypointアプリケーションにおける、Waypoint（WP）とPolygonのマウスインタラクション仕様です。

## Waypoint (WP)

### 🖱️ マウスオーバー (Hover)

**トリガー**: WPマーカーにカーソルを重ねる  
**遅延**: 300ms  
**動作**: Tooltipを表示

**表示内容:**
- WP番号 (例: "WP #3")
- エリア名 (所属ポリゴン名)
- 座標 (decimal形式、6桁精度)
- 標高 (取得済みの場合)
- 飛行制限 (通常空域 / DID / 空港等周辺 / 飛行禁止区域)
- 作成日時 (JST)

**条件**: コンテキストメニューが開いている時は表示しない

---

### 🖱️ 右クリック (Context Menu)

**トリガー**: WPマーカーを右クリック  
**動作**: コンテキストメニューを表示

**メニュー項目:**
- **ヘッダー**: WP番号
- **情報セクション**:
  - ポリゴン名
  - 座標 (decimal形式)
  - 座標 (DMS形式)
  - 標高
  - 作成日時 (JST)
- **アクション**:
  - 📋 座標をコピー (decimal)
  - 🌐 座標をコピー (DMS)
  - 🗑️ 削除

---

### 🖱️ クリック

**トリガー**: WPマーカーをクリック  
**動作**: `onWaypointClick(wp)`を呼び出し  
**効果**: WPを選択状態にする  
**条件**: 編集モード中は無効

---

### 🖱️ ダブルクリック

**動作**: なし

---

### ✋ ドラッグ

**トリガー**: WPマーカーをドラッグ  
**動作**: `onWaypointMove(wpId, lat, lng)`を呼び出し  
**効果**: WPの位置を変更  
**条件**: 編集モード中は無効

---

## Polygon

### 🖱️ マウスオーバー (Hover)

**トリガー**: ポリゴンエリアにカーソルを重ねる  
**遅延**: 300ms  
**動作**: Tooltipを表示

**表示内容:**
- エリア名
- Waypoint数
- 面積 (m²、小数点2桁)
- 作成日時 (JST)

**条件:**
- コンテキストメニューが開いている時は表示しない
- WPがhover中の場合は表示しない

---

### 🖱️ 右クリック (Context Menu)

**トリガー**: ポリゴンエリアを右クリック  
**動作**: コンテキストメニューを表示

**メニュー項目:**
- **ヘッダー**: エリア名
- **情報セクション**:
  - Waypoint一覧 (スクロール可能)
  - 面積
  - 作成日時 (JST)
- **アクション**:
  - 📍 Waypoint頂点一覧を表示 (モーダル)
  - 📋 WP一覧をコピー (decimal)
  - 🌐 WP一覧をコピー (DMS)
  - 👆 選択
  - ✏️ 形状を編集
  - 🗑️ 削除

---

### 🖱️ クリック

**トリガー**: ポリゴンエリアをクリック  
**動作**: `onPolygonSelect(polygonId)`を呼び出し  
**効果**: ポリゴンを選択状態にする (ハイライト表示)

**視覚的変化:**
- fill-opacity: 0.3 → 0.5
- line-width: 2 → 3

---

### 🖱️ ダブルクリック

**トリガー**: ポリゴンエリアをダブルクリック  
**動作**: 編集モードに入る

**効果:**
- ポリゴンの頂点が編集可能になる
- DrawControlが編集モードになる

**注意**: デフォルトのズーム動作は無効化済み

---

## 特殊な操作

### Shift + クリック (Map上)
**動作**: 手動でWaypointを追加  
**条件**: drawModeが有効な場合

---

### Shift + ドラッグ (Map上)
**動作**: 矩形選択でWaypointを複数選択  
**効果**: 選択されたWPを一括操作可能

---

### Delete / Backspace (選択中)
**動作**: 選択中のWaypointを削除

---

### Esc (選択中)
**動作**: 選択をキャンセル

---

## Tooltip表示ロジック

### 優先順位
1. **コンテキストメニューが開いている** → Tooltip非表示
2. **WPがhover中** → Polygon tooltip非表示
3. **その他** → 通常通りtooltip表示

### ビューポート境界検出

Tooltipが画面外にはみ出ないように自動調整します：

- **右端**: カーソルの左側に配置
- **下端**: カーソルの上側に配置
- **左端**: 画面右端から逆算して配置 (`Math.max(MARGIN, window.innerWidth - rect.width - MARGIN)`)
- **上端**: 画面下端から逆算して配置 (`Math.max(MARGIN, window.innerHeight - rect.height - MARGIN)`)

### 遅延時間
**300ms**: ちらつき防止のため

---

## フォント

全てのTooltip、Context Menuで統一されたフォントを使用：

```css
font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
```

**最小フォントサイズ**: 12px

---

## 実装コンポーネント

### MapTooltip
**場所**: `src/components/MapTooltip/`

**主要機能:**
- ビューポート境界検出
- useLayoutEffect による DOM描画前の位置計算
- テーマ対応（Dark/Light）

### ContextMenu
**場所**: `src/components/ContextMenu/`

**主要機能:**
- 情報表示 (`type: 'info'`)
- アクション実行 (`type: 'action'`)
- セクション区切り (`type: 'section'`)
- Glassmorphism デザイン

### VertexListModal
**場所**: `src/components/VertexListModal/`

**主要機能:**
- ポリゴン頂点一覧表示
- 個別座標コピー
- 全座標一括コピー

---

## 関連PR

- **PR #57**: マウスEventオプション統合 (Issue #46)
- **PR #58**: Copilot review対応 + Tooltip改善

---

## 参考資料

- **Issue #46**: マウスEventオプション
- **CLAUDE.md**: プロジェクトガイドライン
